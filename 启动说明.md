# WeCodeSecTools 项目启动说明

## 环境要求

- Python 3.7+
- MySQL 5.7+
- pip 包管理器

## 快速启动

### 1. 安装Python依赖

```bash
# 安装项目依赖包
pip install -r requirements.txt
```

### 2. 配置应用
项目支持两种配置方式：

#### 方式一：使用YAML配置文件（推荐）
编辑 `resources/config.yml` 文件，修改相应的配置参数：
```yaml
flask:
  secret_key: your-secret-key-here
  host: 0.0.0.0
  port: 5000
  debug: false

database:
  mysql:
    host: localhost
    port: 3306
    user: root
    password: your-password
    database: wecode_sec_tools

third_party_api:
  base_url: https://api.example.com
  api_key: your-api-key-here

logging:
  level: INFO
  dir: logs
  file: wecode_sec_tools.log
  max_bytes: 10485760  # 10MB
  backup_count: 5
```

#### 方式二：使用环境变量
设置环境变量（会覆盖YAML配置）：
```bash
# Windows
set SECRET_KEY=your-secret-key-here
set MYSQL_HOST=localhost
set MYSQL_PASSWORD=your-password
set THIRD_PARTY_API_KEY=your-api-key-here
set LOG_LEVEL=DEBUG

# Linux/Mac
export SECRET_KEY=your-secret-key-here
export MYSQL_HOST=localhost
export MYSQL_PASSWORD=your-password
export THIRD_PARTY_API_KEY=your-api-key-here
export LOG_LEVEL=DEBUG
```

### 3. 初始化数据库

#### 方法一：使用Python脚本（推荐）
```bash
python init_db.py
```

#### 方法二：使用SQL脚本
```bash
# 登录MySQL
mysql -u root -p

# 执行SQL脚本
source database_schema.sql
```

### 4. 启动应用

```bash
# 方法一：直接运行
python app.py

# 方法二：使用启动脚本
python run.py
```

应用将在配置的地址和端口启动（默认：`http://localhost:5000`）

## 验证安装

### 1. 检查应用状态
访问 `http://localhost:5000` 应该能看到API信息页面

### 2. 测试API接口
运行测试脚本：
```bash
python test_api.py
```

### 3. 检查数据库
```bash
# 登录MySQL
mysql -u root -p

# 查看数据库
SHOW DATABASES;
USE wecode_sec_tools;
SHOW TABLES;

# 查看表结构
DESCRIBE t_event_activities;
DESCRIBE t_event_artifacts;
```

### 4. 检查日志文件
```bash
# 查看日志目录
ls -la logs/

# 查看应用日志
tail -f logs/wecode_sec_tools.log
```

## API接口说明

### 基础接口
- `GET /` - 获取API信息
- `GET /health` - 健康检查

### 工单管理接口
- `GET /tickets/events` - 获取工单列表
- `GET /tickets/events/<id>` - 获取工单详情
- `POST /tickets/events/<id>/activities` - 创建AI任务
- `GET /tickets/events/<id>/activities` - 获取AI任务列表
- `GET /tickets/events/<id>/artifacts` - 获取AI任务结果

## 项目结构

```
WeCodeSecTools/
├── app.py                 # 主应用文件
├── utils/                 # 工具模块目录
│   ├── __init__.py
│   ├── config.py         # 配置管理
│   └── logging_config.py # 日志配置
├── resources/            # 资源配置目录
│   └── config.yml       # YAML配置文件
├── models/               # 数据模型层
├── services/             # 服务层
├── controllers/          # 控制器层
└── logs/                # 日志文件目录（自动创建）
```

## 常见问题

### 1. 数据库连接失败
- 检查MySQL服务是否启动
- 验证数据库连接参数是否正确
- 确认数据库用户权限

### 2. 依赖包安装失败
```bash
# 升级pip
pip install --upgrade pip

# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 3. 端口被占用
修改 `resources/config.yml` 中的端口号：
```yaml
flask:
  port: 5001
```

### 4. 定时任务不工作
检查日志输出，确认：
- 调度器是否成功启动
- 数据库连接是否正常
- 是否有待处理的任务

### 5. 日志文件权限问题
```bash
# 确保logs目录有写权限
chmod 755 logs/
chmod 644 logs/*.log
```

## 生产环境部署

### 1. 使用Gunicorn
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 2. 使用Nginx反向代理
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 使用Supervisor管理进程
```ini
[program:wecode_sec_tools]
command=python /path/to/your/app.py
directory=/path/to/your/project
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/wecode_sec_tools.log
```

## 监控和日志

### 1. 查看应用日志
应用日志会输出到控制台和文件，包括：
- API请求日志
- 数据库操作日志
- 定时任务执行日志
- 错误和异常信息

### 2. 日志配置
日志配置在 `resources/config.yml` 中：
```yaml
logging:
  level: INFO          # 日志级别
  dir: logs            # 日志目录
  file: wecode_sec_tools.log  # 日志文件名
  max_bytes: 10485760 # 单个日志文件最大大小（10MB）
  backup_count: 5     # 保留的日志文件数量
```

### 3. 数据库监控
```sql
-- 查看任务状态统计
SELECT status, COUNT(*) as count 
FROM t_event_activities 
GROUP BY status;

-- 查看最近创建的任务
SELECT * FROM t_event_activities 
ORDER BY created_at DESC 
LIMIT 10;
```

### 4. 性能监控
- 监控API响应时间
- 监控数据库查询性能
- 监控定时任务执行频率

## 开发模式

### 1. 启用调试模式
修改 `resources/config.yml`：
```yaml
flask:
  debug: true
```

### 2. 调整日志级别
```yaml
logging:
  level: DEBUG
```

### 3. 热重载
安装开发依赖：
```bash
pip install flask-debugtoolbar
```

### 4. 代码格式化
```bash
pip install black
black .
```

## 配置管理

### YAML配置文件结构
```yaml
flask:
  secret_key: ${SECRET_KEY:-dev-secret-key}
  host: 0.0.0.0
  port: 5000
  debug: false

database:
  mysql:
    host: ${MYSQL_HOST:-localhost}
    port: ${MYSQL_PORT:-3306}
    user: ${MYSQL_USER:-root}
    password: ${MYSQL_PASSWORD:-password}
    database: ${MYSQL_DATABASE:-wecode_sec_tools}

third_party_api:
  base_url: ${THIRD_PARTY_API_BASE_URL:-https://api.example.com}
  api_key: ${THIRD_PARTY_API_KEY:-your-api-key}

logging:
  level: ${LOG_LEVEL:-INFO}
  dir: ${LOG_DIR:-logs}
  file: ${LOG_FILE:-wecode_sec_tools.log}
  max_bytes: ${LOG_MAX_BYTES:-10485760}
  backup_count: ${LOG_BACKUP_COUNT:-5}
```

### 环境变量优先级
环境变量 > YAML配置文件 > 默认值

## 安全注意事项

1. 生产环境必须修改默认的SECRET_KEY
2. 数据库密码要使用强密码
3. 第三方API密钥要妥善保管
4. 定期更新依赖包版本
5. 配置防火墙限制端口访问
6. 设置适当的日志文件权限

## 联系支持

如遇到问题，请检查：
1. 日志输出信息（控制台和日志文件）
2. 数据库连接状态
3. 网络连接状态
4. 依赖包版本兼容性
5. 配置文件格式是否正确
6. 日志目录权限是否正确
